
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dynamicAll.base &#8212; dynamicAll 1.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=30646c52"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/dynamicAll/base';</script>
    <link rel="canonical" href="https://jguerra-astro.github.io/dynamicall/_modules/dynamicAll/base.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">dynamicAll 1.0 documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../Installation.html">
    Installation Instructions
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../notebooks/tutorial_potential.html">
    Tutorial: Potentials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../notebooks/tutorial_plummer.html">
    Tutorial: Plummer Model
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../notebooks/tutorial_jfactors.html">
    Tutorial: J-Factors
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../notebooks/tutorial_dracoish.html">
    Tutorial: Numpyro
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../modules.html">
    dynamicAll
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/jguerra-astro/dynamicall" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../Installation.html">
    Installation Instructions
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../notebooks/tutorial_potential.html">
    Tutorial: Potentials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../notebooks/tutorial_plummer.html">
    Tutorial: Plummer Model
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../notebooks/tutorial_jfactors.html">
    Tutorial: J-Factors
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../notebooks/tutorial_dracoish.html">
    Tutorial: Numpyro
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../modules.html">
    dynamicAll
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/jguerra-astro/dynamicall" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">dynamicAll.base</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for dynamicAll.base</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">astropy.constants</span> <span class="k">as</span> <span class="nn">const</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.cosmology</span> <span class="kn">import</span> <span class="n">WMAP9</span> <span class="k">as</span> <span class="n">cosmo</span>
<span class="kn">from</span> <span class="nn">jax._src.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">jaxopt</span> <span class="kn">import</span> <span class="n">Bisection</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">root</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">binned_statistic</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">agama</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.transform</span> <span class="kn">import</span> <span class="n">Rotation</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">histogram</span>


<span class="kn">import</span> <span class="nn">numpyro</span>
<span class="kn">import</span> <span class="nn">numpyro.distributions</span> <span class="k">as</span> <span class="nn">dist</span>
<span class="kn">from</span> <span class="nn">numpyro.diagnostics</span> <span class="kn">import</span> <span class="n">summary</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">numpyro.infer</span> <span class="kn">import</span> <span class="n">MCMC</span><span class="p">,</span> <span class="n">NUTS</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">random</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">corner</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">numpyro.distributions</span> <span class="kn">import</span> <span class="n">Distribution</span>
<span class="kn">from</span> <span class="nn">numpyro.distributions</span> <span class="kn">import</span> <span class="n">constraints</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">lax</span><span class="p">,</span> <span class="n">vmap</span>
<span class="kn">from</span> <span class="nn">jax.lax</span> <span class="kn">import</span> <span class="n">scan</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">random</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">import</span> <span class="nn">emcee</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;jax_enable_x64&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>


<div class="viewcode-block" id="JaxDensity">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity">[docs]</a>
<span class="k">class</span> <span class="nc">JaxDensity</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for Potentials.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ABC : _type_</span>
<span class="sd">        _description_</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Class variables</span>

    <span class="c1"># Priors for the tracer density profile</span>
    <span class="n">_tracer_priors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_dm_priors</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Integration stuff -- 100 is more than enough for the accuracy we need.</span>
    <span class="c1"># Others are here for mostly for testing purposes</span>
    <span class="n">_xk</span><span class="p">,</span> <span class="n">_wk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">leggauss</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">_xk</span><span class="p">,</span> <span class="n">_wk</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_xk</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_wk</span><span class="p">)</span>
    <span class="n">_xm</span><span class="p">,</span> <span class="n">_wm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">leggauss</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">_xm</span><span class="p">,</span> <span class="n">_wm</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_xm</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_wm</span><span class="p">)</span>
    <span class="n">_x256</span><span class="p">,</span> <span class="n">_w256</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">leggauss</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
    <span class="n">_x256</span><span class="p">,</span> <span class="n">_w256</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_x256</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_w256</span><span class="p">)</span>

    <span class="c1"># Need a different accuracy for the J-factor integral</span>
    <span class="n">_xj</span><span class="p">,</span> <span class="n">_wj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">leggauss</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">_xj</span><span class="p">,</span> <span class="n">_wj</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_xj</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_wj</span><span class="p">)</span>

    <span class="c1"># unit conversion used in the J-factor calculation</span>
    <span class="n">_GeV2cm5</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">solMass</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">kpc</span><span class="o">**-</span><span class="mi">5</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="n">_GeVcm2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">solMass</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">kpc</span><span class="o">**-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

    <span class="c1"># Gravitational constant in units useful units.</span>
    <span class="n">_G</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kpc</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">solMass</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="c1"># Gravitational constant in units useful units.</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kpc</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">solMass</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">int_order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">JfactorN</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">Gunit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">kpc</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">solMass</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_G</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kpc</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">solMass</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="c1"># Intregation stuff. 256 is more than enough for the accuracy we need.</span>
        <span class="n">xi</span><span class="p">,</span> <span class="n">wi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">leggauss</span><span class="p">(</span><span class="n">int_order</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_w</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xi</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wi</span><span class="p">)</span>

        <span class="c1"># Need a different accuracy for the J-factor integral</span>
        <span class="n">xj</span><span class="p">,</span> <span class="n">wj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">leggauss</span><span class="p">(</span><span class="n">JfactorN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wj</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xj</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wj</span><span class="p">)</span>

<div class="viewcode-block" id="JaxDensity.density">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.density">[docs]</a>
    <span class="k">def</span> <span class="nf">density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_density</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span></div>


<div class="viewcode-block" id="JaxDensity.mass">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.mass">[docs]</a>
    <span class="k">def</span> <span class="nf">mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span></div>


<div class="viewcode-block" id="JaxDensity.potential">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.potential">[docs]</a>
    <span class="k">def</span> <span class="nf">potential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_potential</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span></div>


<div class="viewcode-block" id="JaxDensity.DistributionFunction">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.DistributionFunction">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">DistributionFunction</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">eps</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Eddington Formula for the distribution function of an isotropic system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r_e</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">test_calculate_re</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="mf">1e10</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">dF_helper</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))(</span><span class="n">eps</span><span class="p">,</span> <span class="n">r_e</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></div>

        <span class="c1"># return jax.vmap(cls.dF_helper, in_axes=(0, 0, None))(eps, r_e, params)</span>
        <span class="c1"># return jax.vmap(lambda e, r: cls.dF_helper(e, r, params))(eps, r_e)</span>

<div class="viewcode-block" id="JaxDensity.dF_helper">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.dF_helper">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">dF_helper</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">r_e</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Eddington formula for the distribution function of a spherical isotropic system.</span>
<span class="sd">        This is using the standard variable names and definitions from Binney &amp; Tremaine (2008) where</span>
<span class="sd">        :math:`\psi(r) = -\Phi(r) + \Phi_{0}`  and :math:`\mathcal{E} = \psi - \frac{1}{2}v^{2}`.</span>
<span class="sd">        In most cases we&#39;ll take \Phi_{0} = 0 in which case :math:`\mathcal{E}` is the binding energy.</span>

<span class="sd">        .. math::</span>
<span class="sd">            f(\mathcal{E}) = \frac{1}{\sqrt{8}\pi^2}\int_{r_\mathcal{E}}^{\infty} \frac{k(r)dr}{\sqrt{\mathcal{E} - \psi(r)}}</span>

<span class="sd">        where k(r)</span>

<span class="sd">        .. math::</span>
<span class="sd">            k(r) = \frac{r^{2}}{GM(r)}\left[\rho&#39;&#39;(r)\ + \rho&#39;(r)\left(\frac{2}{r} - \frac{4\pi r^{2}\rho(r)}{M(r)}\right)\right]</span>

<span class="sd">        See the documentation for more details on the derivation and tests.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        eps : _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_density</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">drho</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_density</span><span class="p">),</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">d2rho</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_density</span><span class="p">)),</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="n">mass</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_mass</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_potential</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">k</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">term1</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">cls</span><span class="o">.</span><span class="n">G</span> <span class="o">/</span> <span class="n">mass</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">term2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rho</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">mass</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">term3</span> <span class="o">=</span> <span class="n">d2rho</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">+</span> <span class="n">drho</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">*</span> <span class="n">term2</span>
            <span class="k">return</span> <span class="n">term1</span> <span class="o">*</span> <span class="n">term3</span>

        <span class="k">def</span> <span class="nf">integrand</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">return</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">k</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">epsilon</span> <span class="o">+</span> <span class="n">phi</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>

        <span class="n">coeff</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">def</span> <span class="nf">test_integrand</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">small</span><span class="p">():</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">r_e</span><span class="p">)</span>
                <span class="n">term1</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">G</span> <span class="o">*</span> <span class="n">mass</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">term2</span> <span class="o">=</span> <span class="n">delta</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rho</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="bp">cls</span><span class="o">.</span><span class="n">G</span> <span class="o">*</span> <span class="n">mass</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span>
                <span class="p">)</span>
                <span class="n">dphi</span> <span class="o">=</span> <span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span>
                <span class="k">return</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">k</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dphi</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">large</span><span class="p">():</span>
                <span class="n">dphi</span> <span class="o">=</span> <span class="n">epsilon</span> <span class="o">+</span> <span class="n">phi</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">k</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dphi</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">r_e</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="n">small</span><span class="p">(),</span> <span class="n">large</span><span class="p">())</span>

        <span class="c1"># Integrate from r_epsilon to infinity</span>

        <span class="n">xi</span><span class="p">,</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_xm</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_wm</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">xk</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="n">xi</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x0</span><span class="p">)</span>
        <span class="n">wk</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="n">wi</span>

        <span class="n">_integrand</span> <span class="o">=</span> <span class="n">test_integrand</span>

        <span class="k">return</span> <span class="n">r_e</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">wk</span> <span class="o">*</span> <span class="n">_integrand</span><span class="p">(</span><span class="n">r_e</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">),</span> <span class="n">eps</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="JaxDensity.calculate_re">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.calculate_re">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">calculate_re</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">rlim</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function for calculating the distribution function.</span>
<span class="sd">        Calculates the radius at which:math:`\Psi(r) = \epsilon`</span>
<span class="sd">        See the documentation for more details on the derivation and tests.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        epsilon : _type_</span>
<span class="sd">            :math:`\epsilon = \psi(r) - \frac{1}{2}v^{2}`  | [kpc^{2}~s^{-2}]</span>
<span class="sd">        rlim : _type_</span>
<span class="sd">            Limit for the radius at which to calculate the distribution function, For small energies, the radius at which the potential is equal to epsilon can get very large.</span>
<span class="sd">        params : _type_</span>
<span class="sd">            parameters for the specific model being used</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">psi_minus_epsilon</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">potential</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_potential</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">potential</span> <span class="o">-</span> <span class="n">epsilon</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;r: </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">, potential: </span><span class="si">{</span><span class="n">potential</span><span class="si">}</span><span class="s2">, psi_minus_epsilon: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># Check function values at bounds</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="mf">1e-12</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">rlim</span>
        <span class="n">f_lower</span> <span class="o">=</span> <span class="n">psi_minus_epsilon</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span>
        <span class="n">f_upper</span> <span class="o">=</span> <span class="n">psi_minus_epsilon</span><span class="p">(</span><span class="n">upper</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function value at lower bound: </span><span class="si">{</span><span class="n">f_lower</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function value at upper bound: </span><span class="si">{</span><span class="n">f_upper</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">f_lower</span> <span class="o">*</span> <span class="n">f_upper</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Function does not change sign between bounds!&quot;</span><span class="p">)</span>

        <span class="n">solver</span> <span class="o">=</span> <span class="n">Bisection</span><span class="p">(</span>
            <span class="n">psi_minus_epsilon</span><span class="p">,</span>
            <span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span>
            <span class="n">upper</span><span class="o">=</span><span class="n">upper</span><span class="p">,</span>
            <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">tol</span><span class="o">=</span><span class="mf">1e-20</span><span class="p">,</span>
            <span class="n">check_bracket</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bisection result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span></div>


<div class="viewcode-block" id="JaxDensity.test_calculate_re">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.test_calculate_re">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">test_calculate_re</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">rlim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function for calculating the distribution function.</span>
<span class="sd">        Calculates the radius at which:math:`\Psi(r) = \epsilon`</span>
<span class="sd">        See the documentation for more details on the derivation and tests.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        epsilon : _type_</span>
<span class="sd">            :math:`\epsilon = \psi(r) - \frac{1}{2}v^{2}`  | [kpc^{2}~s^{-2}]</span>
<span class="sd">        rlim : _type_</span>
<span class="sd">            Limit for the radius at which to calculate the distribution function, For small energies, the radius at which the potential is equal to epsilon can get very large.</span>
<span class="sd">        params : _type_</span>
<span class="sd">            parameters for the specific model being used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_potential</span>

        <span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
        <span class="k">def</span> <span class="nf">psi_minus_epsilon</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eps</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phi</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span> <span class="o">-</span> <span class="n">eps</span>

        <span class="k">def</span> <span class="nf">bisection_solver</span><span class="p">(</span><span class="n">eps</span><span class="p">):</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">Bisection</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">psi_minus_epsilon</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eps</span><span class="p">),</span>
                <span class="n">lower</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span>
                <span class="n">upper</span><span class="o">=</span><span class="n">rlim</span><span class="p">,</span>
                <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                <span class="n">tol</span><span class="o">=</span><span class="mf">1e-20</span><span class="p">,</span>
                <span class="n">check_bracket</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">solver</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">params</span>

        <span class="n">vectorized_bisect</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">bisection_solver</span><span class="p">)</span>
        <span class="n">r_epsilon</span> <span class="o">=</span> <span class="n">vectorized_bisect</span><span class="p">(</span><span class="n">epsilon</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r_epsilon</span></div>


<div class="viewcode-block" id="JaxDensity.DF">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.DF">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">DF</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Eddington Formula for the distribution function of an isotropic system</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">calculate_re</span><span class="p">(</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">rlim</span><span class="p">):</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_potential</span>

            <span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
            <span class="k">def</span> <span class="nf">psi_minus_epsilon</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eps</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phi</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">-</span> <span class="n">eps</span>

            <span class="k">def</span> <span class="nf">bisection_solver</span><span class="p">(</span><span class="n">eps</span><span class="p">):</span>
                <span class="n">solver</span> <span class="o">=</span> <span class="n">Bisection</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">psi_minus_epsilon</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eps</span><span class="p">),</span>
                    <span class="n">lower</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span>
                    <span class="n">upper</span><span class="o">=</span><span class="n">rlim</span><span class="p">,</span>
                    <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                    <span class="n">tol</span><span class="o">=</span><span class="mf">1e-20</span><span class="p">,</span>
                    <span class="n">check_bracket</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">solver</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">params</span>

            <span class="n">vectorized_bisect</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">bisection_solver</span><span class="p">)</span>
            <span class="n">r_epsilon</span> <span class="o">=</span> <span class="n">vectorized_bisect</span><span class="p">(</span><span class="n">epsilon</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r_epsilon</span>

        <span class="c1"># get rlim from keyword arguments</span>
        <span class="n">rlim</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rlim&quot;</span><span class="p">,</span> <span class="mf">1e10</span><span class="p">)</span>
        <span class="n">r_e</span> <span class="o">=</span> <span class="n">calculate_re</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">rlim</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r_e</span></div>

        <span class="c1"># return cls.dF_helper(eps, params, r_e)</span>

<div class="viewcode-block" id="JaxDensity.dJdOmega">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.dJdOmega">[docs]</a>
    <span class="k">def</span> <span class="nf">dJdOmega</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">rt</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. math:</span>
<span class="sd">            \frac{dJ}{d\omega} = \int{\rho^{2}(r) d\ell}</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        theta : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l0</span> <span class="o">=</span> <span class="n">D</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rt</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">D</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">l1</span> <span class="o">=</span> <span class="n">D</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rt</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">D</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">l1</span> <span class="o">-</span> <span class="n">l0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xj</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">l1</span> <span class="o">+</span> <span class="n">l0</span><span class="p">)</span>
        <span class="n">wi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">l1</span> <span class="o">-</span> <span class="n">l0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wj</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">wi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">D</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">xi</span> <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="JaxDensity.jFactor">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.jFactor">[docs]</a>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">jFactor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rt</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        J-factor</span>

<span class="sd">        .. math:</span>
<span class="sd">            J= \int\int_{\rm los} \rho^{2}(r) d\Omega dl</span>

<span class="sd">        where we write r as :math:`r^2=\ell^2+d^2-2 \ell d \cos \theta` where :math:`\ell` is the distance along the line of sight and d is the distance to the center of the galaxy.</span>
<span class="sd">        Spherical symmetry lets us write :math:`d\Omega=2\pi\sin\theta d\theta`.</span>

<span class="sd">        The bounds on the line of sight are $\ell_{ \pm}=d \cos \theta \pm \sqrt{r_{200}^2-d^2 \sin ^2 \theta}$.</span>
<span class="sd">        where $r_{200}$ is the &#39;size&#39; of the system.</span>

<span class="sd">        substituting in the integral we get</span>
<span class="sd">        $$</span>
<span class="sd">        J(\theta_{\rm max}) = 2 \pi \int_{0}^{\theta_{\rm max}} \int_{\ell_{-}}^{\ell_{+}} \left[\rho\left(\sqrt{\ell^2+d^2-2 \ell d \cos \theta}\right)\right]^{2}\sin(\theta) d\ell d\theta</span>
<span class="sd">        $$</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        theta : float</span>
<span class="sd">            _description_</span>
<span class="sd">        d : float</span>
<span class="sd">            distance to system | [kpc]</span>
<span class="sd">        rt : float</span>
<span class="sd">            tidal radius of system | [kpc]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            J-factor | [:math:`M_{\odot}^{2}~kpc^{-5}]`</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Should rt just be r_200? should i just change the bounds on the line of sight part to be -inf to inf?</span>
<span class="sd">        Note the Units.</span>
<span class="sd">        Maybe I should just return log10(J/[GeV^{2} cm^{-5}]) instead of J?</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xj</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x0</span><span class="p">)</span>
        <span class="n">wi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wj</span>
        <span class="n">vectorized_func</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dJdOmega</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
            <span class="mi">2</span>
            <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span>
            <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">wi</span> <span class="o">*</span> <span class="n">vectorized_func</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rt</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xi</span><span class="p">))</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GeV2cm5</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="JaxDensity.dDdOmega">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.dDdOmega">[docs]</a>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">dDdOmega</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        _summary_</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        theta : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        d : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        rt : _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l0</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rt</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">l1</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rt</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">l1</span> <span class="o">-</span> <span class="n">l0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xj</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">l1</span> <span class="o">+</span> <span class="n">l0</span><span class="p">)</span>
        <span class="n">wi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">l1</span> <span class="o">-</span> <span class="n">l0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wj</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">wi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">d</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">xi</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)))</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="JaxDensity.dFactor">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.dFactor">[docs]</a>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">dFactor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decay Factor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        theta : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        d : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        rt : _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Decay Factor | [:math:`M_{\odot}~kpc^{-2}]`</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        TODO: Decide on the units and log10 or not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xj</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x0</span><span class="p">)</span>
        <span class="n">wi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wj</span>
        <span class="n">vectorized_func</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dDdOmega</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
            <span class="mi">2</span>
            <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span>
            <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">wi</span> <span class="o">*</span> <span class="n">vectorized_func</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rt</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xi</span><span class="p">))</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GeVcm2</span>
        <span class="p">)</span></div>


    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_density</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_mass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">r</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rs&quot;</span><span class="p">]</span>

        <span class="n">xi</span> <span class="o">=</span> <span class="n">JaxPotential</span><span class="o">.</span><span class="n">_x256</span>
        <span class="n">wi</span> <span class="o">=</span> <span class="n">JaxPotential</span><span class="o">.</span><span class="n">_w256</span>

        <span class="k">def</span> <span class="nf">r_le_rs</span><span class="p">():</span>
            <span class="n">xk</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">xi</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">q</span>
            <span class="n">wk</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">wi</span>
            <span class="k">return</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">wk</span> <span class="o">*</span> <span class="n">xk</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_density</span><span class="p">(</span><span class="n">xk</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">r_gt_rs</span><span class="p">():</span>
            <span class="c1"># first ingrate from 0 to rs</span>
            <span class="c1"># then integrate from rs to r</span>

            <span class="n">x1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">rs</span> <span class="o">*</span> <span class="n">xi</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">rs</span>
            <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">rs</span> <span class="o">*</span> <span class="n">wi</span>
            <span class="n">m_rs</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w1</span> <span class="o">*</span> <span class="n">x1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_density</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">x2</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">rs</span><span class="p">)</span> <span class="o">*</span> <span class="n">xi</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">rs</span><span class="p">)</span>
            <span class="n">w2</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">rs</span><span class="p">)</span> <span class="o">*</span> <span class="n">wi</span>
            <span class="n">m_r</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w2</span> <span class="o">*</span> <span class="n">x2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_density</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">m_rs</span> <span class="o">+</span> <span class="n">m_r</span>

        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">r</span> <span class="o">&lt;=</span> <span class="n">rs</span><span class="p">,</span>
            <span class="n">r_le_rs</span><span class="p">,</span>
            <span class="n">r_gt_rs</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="JaxDensity.test_mass">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.test_mass">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">test_mass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Integration using Gauss-Legendre quadrature + trigonometric substitution, didn&#39;t make much of a difference,</span>
<span class="sd">        but i&#39;ll leave it around for more testing</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        params : _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rs&quot;</span><span class="p">]</span>

        <span class="n">xi</span> <span class="o">=</span> <span class="n">JaxPotential</span><span class="o">.</span><span class="n">_xk</span>
        <span class="n">wi</span> <span class="o">=</span> <span class="n">JaxPotential</span><span class="o">.</span><span class="n">_wk</span>

        <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">xk</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">xi</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x1</span>
        <span class="n">wk</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">wi</span>

        <span class="k">def</span> <span class="nf">r_le_rs</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="mi">4</span>
                <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span>
                <span class="o">*</span> <span class="n">r</span>
                <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">wk</span>
                    <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_density</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xk</span><span class="p">),</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">r_gt_rs</span><span class="p">():</span>
            <span class="c1"># first ingrate from 0 to rs</span>
            <span class="c1"># then integrate from rs to r</span>
            <span class="n">m_rs</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mi">4</span>
                <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span>
                <span class="o">*</span> <span class="n">rs</span>
                <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">wk</span>
                    <span class="o">*</span> <span class="p">(</span><span class="n">rs</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_density</span><span class="p">(</span><span class="n">rs</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xk</span><span class="p">),</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">x2</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">rs</span> <span class="o">/</span> <span class="n">r</span><span class="p">))</span> <span class="o">*</span> <span class="n">xi</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">rs</span> <span class="o">/</span> <span class="n">r</span><span class="p">))</span>
            <span class="n">w2</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">rs</span> <span class="o">/</span> <span class="n">r</span><span class="p">))</span> <span class="o">*</span> <span class="n">wi</span>
            <span class="n">m_r</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mi">4</span>
                <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span>
                <span class="o">*</span> <span class="n">r</span>
                <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">w2</span>
                    <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x2</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_density</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x2</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x2</span><span class="p">),</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">m_rs</span> <span class="o">+</span> <span class="n">m_r</span>

        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">r</span> <span class="o">&lt;=</span> <span class="n">rs</span><span class="p">,</span>
            <span class="n">r_le_rs</span><span class="p">,</span>
            <span class="n">r_gt_rs</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="JaxDensity.test_potential">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.test_potential">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">test_potential</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the potential at a given radius r numerically</span>

<span class="sd">        .. math::</span>
<span class="sd">            \phi(r) = -4\pi G\left[\frac{M}{r}+ \int_{r}^{\infty} \rho(r) r dr \right]</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : _type_</span>
<span class="sd">            float</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            potential at a given radius r | [kpc^{2}~s^{-2}]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">JaxPotential</span><span class="o">.</span><span class="n">G</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">r</span>
        <span class="n">phi_in</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_mass</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span>

        <span class="c1"># we&#39;ll use Jax&#39;s flow control to split up integration into two regimes r &lt;&lt; rs and r &gt;&gt; rs</span>
        <span class="c1"># this will avoid numerical issues with the trig substitution for r &lt;&lt; rs</span>
        <span class="c1"># for r &gt;&gt; rs, the trig substitution is needed in order to turn the integral into a finite integral</span>
        <span class="c1"># TODO: for when there is a limit on the upper bound of the integral we again swith integration schemes - yet to be implemented</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_xk</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_wk</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">xk</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x0</span><span class="p">)</span>
        <span class="n">wk</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span>

        <span class="k">def</span> <span class="nf">less_than_rs</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            for r &lt;&lt; rs, (\frac{r}{r_{s}} &lt; 1e-5, depending on the order of the integration) the trig substitution usually used leads to numerical issues.</span>
<span class="sd">            Instead just use regular Gauss-Legendre quadrature from r to rs. then use the trig substitution to</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># x0_ = r</span>
            <span class="c1"># x1_ = params[&quot;rs&quot;]</span>
            <span class="c1"># xi = 0.5 * (x1_ - x0_) * x + 0.5 * (x1_ + x0_)</span>
            <span class="c1"># wi = 0.5 * (x1_ - x0_) * w</span>

            <span class="c1"># # integrate from r to rs</span>
            <span class="c1"># t1 = jnp.sum(wi * cls._density(xi, params) * xi, axis=0)</span>
            <span class="c1"># x0 = jnp.arcsin(r / params[&quot;rs&quot;])</span>
            <span class="c1"># x1 = jnp.pi / 2</span>

            <span class="n">xi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x0</span><span class="p">)</span>
            <span class="n">wi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">wi</span>
                <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_density</span><span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xi</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">r</span>
                <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
                <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># integrate from rs to infinity</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rs&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">wk</span>
                <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_density</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;rs&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rs&quot;</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span>
                <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># integrate from rs to infinity</span>

            <span class="c1"># sum the two integrals</span>
            <span class="k">return</span> <span class="n">t1</span> <span class="o">+</span> <span class="n">t2</span>

        <span class="k">def</span> <span class="nf">greater_than_rs</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            fro r &gt; rs, the trig substitution behaves well and transforms the infinity integral into a finite one</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">phi_out</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">wk</span>
                <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_density</span><span class="p">(</span><span class="n">q</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">q</span>
                <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span>
                <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">phi_out</span>

        <span class="n">phi_out</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rs&quot;</span><span class="p">],</span> <span class="n">less_than_rs</span><span class="p">,</span> <span class="n">greater_than_rs</span><span class="p">)</span>

        <span class="k">return</span> <span class="o">-</span><span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi_in</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">phi_out</span><span class="p">)</span></div>


    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_potential</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">JaxPotential</span><span class="o">.</span><span class="n">G</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">r</span>
        <span class="n">phi_in</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_mass</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_xm</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_wm</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">xk</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x0</span><span class="p">)</span>
        <span class="n">wk</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span>

        <span class="k">def</span> <span class="nf">very_small_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            For r &lt; 1e-4, we use a specialized integration technique or approximation</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Implement your integration technique for very small r</span>
            <span class="c1"># This is a placeholder implementation; adjust as needed</span>
            <span class="n">lambda_</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;rs&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">r</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">transformed_integrand</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lambda_</span> <span class="o">*</span> <span class="n">u</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_density</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lambda_</span>

            <span class="n">u_min</span><span class="p">,</span> <span class="n">u_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
            <span class="n">u_vals</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">u_max</span> <span class="o">-</span> <span class="n">u_min</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">u_min</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">u_max</span> <span class="o">-</span> <span class="n">u_min</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">transformed_integrand</span><span class="p">(</span><span class="n">u_vals</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">t2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rs&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">wk</span>
                <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_density</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;rs&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rs&quot;</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span>
                <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">t1</span> <span class="o">+</span> <span class="n">t2</span>

        <span class="k">def</span> <span class="nf">less_than_rs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">x0_</span> <span class="o">=</span> <span class="n">r</span>
            <span class="n">x1_</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rs&quot;</span><span class="p">]</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1_</span> <span class="o">-</span> <span class="n">x0_</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1_</span> <span class="o">+</span> <span class="n">x0_</span><span class="p">)</span>
            <span class="n">wi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1_</span> <span class="o">-</span> <span class="n">x0_</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">wi</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_density</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">*</span> <span class="n">xi</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">t2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rs&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">wk</span>
                <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_density</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;rs&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rs&quot;</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span>
                <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">t1</span> <span class="o">+</span> <span class="n">t2</span>

        <span class="k">def</span> <span class="nf">greater_than_rs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">q</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">wk</span>
                <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_density</span><span class="p">(</span><span class="n">q</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">q</span>
                <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span>
                <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Nested conditional to handle three cases</span>
        <span class="k">def</span> <span class="nf">inner_condition</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">r</span> <span class="o">&lt;=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rs&quot;</span><span class="p">],</span>
                <span class="k">lambda</span> <span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">less_than_rs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span>
                <span class="k">lambda</span> <span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">greater_than_rs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span>
                <span class="n">r</span><span class="p">,</span>
                <span class="n">params</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">phi_out</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">r</span> <span class="o">&lt;=</span> <span class="mf">1e-1</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">very_small_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span>
            <span class="k">lambda</span> <span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">inner_condition</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span>
            <span class="n">r</span><span class="p">,</span>
            <span class="n">params</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="o">-</span><span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi_in</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">phi_out</span><span class="p">)</span>

<div class="viewcode-block" id="JaxDensity.v_circ">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.v_circ">[docs]</a>
    <span class="k">def</span> <span class="nf">v_circ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        circular velocity at a given radius r</span>

<span class="sd">        .. math::</span>
<span class="sd">            v_{circ} = \sqrt{r\frac{d\phi}{dr}} = \sqrt{\frac{GM(r)}{r}}</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_G</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span><span class="p">)</span></div>


<div class="viewcode-block" id="JaxDensity.v_esc">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.v_esc">[docs]</a>
    <span class="k">def</span> <span class="nf">v_esc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the escape velocity at a given radius r</span>

<span class="sd">        .. math::</span>
<span class="sd">            v_{esc} = \sqrt{-2\phi(r)}</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential</span><span class="p">(</span><span class="n">r</span><span class="p">))</span></div>


    <span class="c1"># @partial(jax.jit, static_argnums=(0,))</span>
<div class="viewcode-block" id="JaxDensity.total_energy">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.total_energy">[docs]</a>
    <span class="k">def</span> <span class="nf">total_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the total energy per unit mass</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        v : _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            total energy per unit mass | [km^{2}~s^{-2}]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">T</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>  <span class="c1"># kinetic energy</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">T</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential</span><span class="p">(</span><span class="n">r</span><span class="p">)</span></div>


<div class="viewcode-block" id="JaxDensity.gamma">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.gamma">[docs]</a>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">gamma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        log-slope of density profile.</span>

<span class="sd">        .. math:</span>
<span class="sd">            \gamma = -\frac{d\log(\rho)}{d\log(r)}`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">grad</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">(</span><span class="n">r</span><span class="p">)</span></div>


<div class="viewcode-block" id="JaxDensity.r200">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.r200">[docs]</a>
    <span class="k">def</span> <span class="nf">r200</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Calculate r200 between 1e-2 kpc and 300 kpc</span>
<span class="sd">        I&#39;m assuming thats a safe range in which r200 for a dwarf galaxy would be, but I COULD be wrong</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        check_bracket = False otherwise the function is not jittable</span>
<span class="sd">        This might actually be more useful</span>
<span class="sd">        BUG: lower=1e-20 does not work with the NFW class for some reason even though its analytical... must look into this at some point</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            helper function for calculating r_{200} for a given density/mass profile.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            x : float</span>
<span class="sd">                Has to be in kpc for the units to work out</span>
<span class="sd">                but it cant have units otherwise the function won&#39;t work..</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            float</span>
<span class="sd">                average density - 200\rho_{crit}</span>

<span class="sd">            Notes</span>
<span class="sd">            -----</span>
<span class="sd">            This doesnt really belong here -- at least not in this structure</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># x = jnp.atleast_1d(x)</span>
            <span class="n">rho_crit</span> <span class="o">=</span> <span class="mf">133.3636319527206</span>  <span class="c1"># critical density from astropy&#39;s WMAP9 with units [solMass/kpc**3]</span>
            <span class="n">Delta</span> <span class="o">=</span> <span class="mf">200.0</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">Delta</span> <span class="o">*</span> <span class="n">rho_crit</span>

        <span class="n">bisec</span> <span class="o">=</span> <span class="n">Bisection</span><span class="p">(</span>
            <span class="n">optimality_fun</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">check_bracket</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">bisec</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">params</span></div>


<div class="viewcode-block" id="JaxDensity.rtidal">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.rtidal">[docs]</a>
    <span class="k">def</span> <span class="nf">rtidal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r_dsph</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        _summary_</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r_dsph : _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">models</span>

        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_dsph</span><span class="p">):</span>
            <span class="c1"># e.g. gala&#39;s default parameters for the Milky Way Halo</span>
            <span class="n">mw_ms</span> <span class="o">=</span> <span class="mf">5.4e11</span>  <span class="c1"># Msun - scale mass</span>
            <span class="n">mw_rs</span> <span class="o">=</span> <span class="mf">15.62</span>  <span class="c1"># kpc  - scale radius</span>

            <span class="n">dSph_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">(</span><span class="n">r</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">mw_mass</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NFW</span><span class="o">.</span><span class="n">from_ms_rs</span><span class="p">(</span><span class="n">mw_ms</span><span class="p">,</span> <span class="n">mw_rs</span><span class="p">)</span><span class="o">.</span><span class="n">mass</span><span class="p">(</span><span class="n">r_dsph</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dSph_mass</span> <span class="o">*</span> <span class="p">(</span><span class="n">r_dsph</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="n">r</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">mw_mass</span>

        <span class="n">bisec</span> <span class="o">=</span> <span class="n">Bisection</span><span class="p">(</span>
            <span class="n">optimality_fun</span><span class="o">=</span><span class="n">func</span><span class="p">,</span>
            <span class="n">lower</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
            <span class="n">upper</span><span class="o">=</span><span class="n">r_dsph</span><span class="p">,</span>
            <span class="n">check_bracket</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">maxiter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">bisec</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">r_dsph</span><span class="o">=</span><span class="n">r_dsph</span><span class="p">)</span><span class="o">.</span><span class="n">params</span></div>


<div class="viewcode-block" id="JaxDensity.r200_notjax">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.r200_notjax">[docs]</a>
    <span class="k">def</span> <span class="nf">r200_notjax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Radius at which the average density of the halo is equal to 200 times the critical density</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This one works on models that aren&#39;t jax friendly</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rho_crit</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">critical_density</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">solMass</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">kpc</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">Delta</span> <span class="o">=</span> <span class="mi">200</span>

        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_mass</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">Delta</span> <span class="o">*</span> <span class="n">rho_crit</span>
            <span class="p">)</span>  <span class="c1"># set average density - 200* rho_crit = 0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_r200</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">bisect</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_M200</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r200</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r200</span></div>


<div class="viewcode-block" id="JaxDensity.sample_w">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.sample_w">[docs]</a>
    <span class="k">def</span> <span class="nf">sample_w</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">N</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">r_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span>
        <span class="n">v_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">nwalkers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
        <span class="n">N_burn</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10_000</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use emcee to generate samples of :math:`vec{w} = (\vec{x},\vec{v}) from the distribution function f(vec{w}) = f(E)`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        N : int</span>
<span class="sd">            _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">G</span> <span class="o">=</span> <span class="mf">4.300917270036279e-06</span>  <span class="c1"># gravitational constant in units of kpc km^2 s^-2 Msol^-1</span>

        <span class="k">def</span> <span class="nf">df</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">w</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">logDF</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">log_prior</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">w</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="n">Energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

            <span class="c1"># if (Energy &lt; 0) and (Energy &gt; -G*self._M/self._a): and (r &lt; 50):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Energy</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">70</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">):</span>
                <span class="c1"># TODO: must change r &lt; 70 to something like r &lt; r_200, also include v_esc?s</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="k">def</span> <span class="nf">log_probability</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="n">lp</span> <span class="o">=</span> <span class="n">log_prior</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lp</span><span class="p">):</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">return</span> <span class="n">lp</span> <span class="o">+</span> <span class="n">df</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="n">ndim</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">r_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">)</span>
        <span class="c1"># print(r_temp.shape)</span>
        <span class="n">v_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_circ</span><span class="p">(</span><span class="n">r_temp</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spherical_to_cartesian</span><span class="p">(</span><span class="n">r_temp</span><span class="p">)</span>
        <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spherical_to_cartesian</span><span class="p">(</span><span class="n">v_temp</span><span class="p">)</span>

        <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># p0 = np.random.rand(nwalkers, ndim) # need to make p0 better</span>
        <span class="c1"># print(p0.shape)</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">log_probability</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">N_burn</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sampler</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">get_chain</span><span class="p">(</span><span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># print(</span>
        <span class="c1">#     &quot;Mean acceptance fraction: {0:.3f}&quot;.format(</span>
        <span class="c1">#         np.mean(sampler.acceptance_fraction)</span>
        <span class="c1">#     )</span>
        <span class="c1"># )</span>
        <span class="c1"># print(</span>
        <span class="c1">#     &quot;Mean autocorrelation time: {0:.3f} steps&quot;.format(</span>
        <span class="c1">#         np.mean(sampler.get_autocorr_time())</span>
        <span class="c1">#     )</span>
        <span class="c1"># )</span>
        <span class="k">return</span> <span class="n">samples</span></div>


<div class="viewcode-block" id="JaxDensity.spherical_to_cartesian">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.spherical_to_cartesian">[docs]</a>
    <span class="k">def</span> <span class="nf">spherical_to_cartesian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">):</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">temp</span><span class="p">)</span>

        <span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">quantity</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">quantity</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">xyz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">quantity</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xyz</span></div>


<div class="viewcode-block" id="JaxDensity.project">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.project">[docs]</a>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward Abel transform : Project an optically thin, spherically symmetric function onto a plane.</span>
<span class="sd">        :math:`f(r(x,y,z))\rightarrow F(R(x,y))`</span>

<span class="sd">        .. math::</span>
<span class="sd">            F(R)=2 \int_R^{\infty} \frac{f(r) r}{\sqrt{r^2-R^2}} d r</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func : Callable</span>
<span class="sd">            function of projected (on-sky) radii, R</span>
<span class="sd">        R : jax.Array</span>
<span class="sd">            Projected distance :math:`(R = \sqrt{x^2 +y^2})`</span>

<span class="sd">        params :</span>
<span class="sd">            parameters for func</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        jax.Array</span>
<span class="sd">            projected positions</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">f_abel</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">q</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">R</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># integral goes from R to infinity</span>
        <span class="c1"># use u-sub wit u = R csc(theta) -&gt; du = -R cos(theta)/sin^2(theta) dtheta</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="c1"># x,w = np.polynomial.legendre.leggauss(100) # are these tabulated -- does it take a long time to calculate?</span>

        <span class="n">xk</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xj</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x0</span><span class="p">)</span>
        <span class="n">wk</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wj</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">wk</span> <span class="o">*</span> <span class="n">f_abel</span><span class="p">(</span><span class="n">R</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">),</span> <span class="n">R</span><span class="p">)</span> <span class="o">*</span> <span class="n">R</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="JaxDensity.deproject">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.deproject">[docs]</a>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">deproject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inverse Abel transform is used to calculate the emission function given a projection, i.e.</span>
<span class="sd">        :math:`F(R(x,y)) \rightarrow f( r(x,y,z) )`</span>

<span class="sd">        .. math::</span>
<span class="sd">            f(r)=-\frac{1}{\pi} \int_r^{\infty} \frac{d F}{d y} \frac{d y}{\sqrt{y^2-r^2}}</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func : Callable</span>
<span class="sd">            function of :math:`r = \sqrt{x^2+y^2+z^2}.` This must be written in a jax friendly way so that it can be differentiated</span>
<span class="sd">        R : np.ndarray</span>
<span class="sd">            _description_</span>
<span class="sd">        params : _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># write everything out for clarity</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">xk</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xk</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x0</span><span class="p">)</span>
        <span class="n">wk</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wk</span>

        <span class="n">dfunc</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># dfunc = jax.vmap(jax.grad(self.projected_density,argnums=0))</span>
        <span class="c1"># return dfunc(r)</span>
        <span class="k">def</span> <span class="nf">f_abel</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">dfunc</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">wk</span> <span class="o">*</span> <span class="n">f_abel</span><span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">),</span> <span class="n">r</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="JaxDensity.set_Norder">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.set_Norder">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_Norder</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">new_xk</span><span class="p">,</span> <span class="n">new_wk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">leggauss</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_xk</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_xk</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_wk</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_wk</span><span class="p">)</span></div>


<div class="viewcode-block" id="JaxDensity.get_tracer_priors">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.get_tracer_priors">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_tracer_priors</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: Add instance for Normal distribution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">distribution</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_tracer_priors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">distribution_name</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">distribution</span><span class="p">,</span> <span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">LogUniform</span><span class="p">)):</span>
                <span class="n">low</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">distribution</span><span class="o">.</span><span class="n">low</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">high</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">distribution</span><span class="o">.</span><span class="n">high</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">bounds_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Bounds: (</span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s2">)&quot;</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">distribution</span><span class="p">,</span> <span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">)):</span>
                <span class="n">mean</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">distribution</span><span class="o">.</span><span class="n">loc</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">std_dev</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">distribution</span><span class="o">.</span><span class="n">scale</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">bounds_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Mean: </span><span class="si">{</span><span class="n">mean</span><span class="si">}</span><span class="s2">, StdDev: </span><span class="si">{</span><span class="n">std_dev</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bounds_info</span> <span class="o">=</span> <span class="s2">&quot;No Bounds&quot;</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter: </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">, Distribution: </span><span class="si">{</span><span class="n">distribution_name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">bounds_info</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="JaxDensity.set_tracer_priors">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.set_tracer_priors">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_tracer_priors</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">new_priors</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_tracer_priors</span> <span class="o">=</span> <span class="n">new_priors</span></div>


<div class="viewcode-block" id="JaxDensity.get_dm_priors">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.get_dm_priors">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_dm_priors</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">distribution</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_dm_priors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">distribution_name</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">distribution</span><span class="p">,</span> <span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">LogUniform</span><span class="p">)):</span>
                <span class="n">low</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">distribution</span><span class="o">.</span><span class="n">low</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">high</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">distribution</span><span class="o">.</span><span class="n">high</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">bounds_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Bounds: (</span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s2">)&quot;</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">distribution</span><span class="p">,</span> <span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">)):</span>
                <span class="n">mean</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">distribution</span><span class="o">.</span><span class="n">loc</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">std_dev</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">distribution</span><span class="o">.</span><span class="n">scale</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">bounds_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Mean: </span><span class="si">{</span><span class="n">mean</span><span class="si">}</span><span class="s2">, StdDev: </span><span class="si">{</span><span class="n">std_dev</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bounds_info</span> <span class="o">=</span> <span class="s2">&quot;No Bounds&quot;</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter: </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">, Distribution: </span><span class="si">{</span><span class="n">distribution_name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">bounds_info</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="JaxDensity.set_dm_priors">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.set_dm_priors">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_dm_priors</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">new_priors</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_dm_priors</span> <span class="o">=</span> <span class="n">new_priors</span></div>


    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_peri</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">):</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">bisec</span> <span class="o">=</span> <span class="n">Bisection</span><span class="p">(</span>
            <span class="n">optimality_fun</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_centre</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">r0</span><span class="p">,</span> <span class="n">check_bracket</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">r_peri</span> <span class="o">=</span> <span class="n">bisec</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="n">v0</span><span class="p">,</span> <span class="n">pars</span><span class="o">=</span><span class="n">pars</span><span class="p">)</span><span class="o">.</span><span class="n">params</span>
        <span class="k">return</span> <span class="n">r_peri</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_apo</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">):</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">bisec2</span> <span class="o">=</span> <span class="n">Bisection</span><span class="p">(</span>
            <span class="n">optimality_fun</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_centre</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="n">r0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">check_bracket</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">r_apo</span> <span class="o">=</span> <span class="n">bisec2</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="n">v0</span><span class="p">,</span> <span class="n">pars</span><span class="o">=</span><span class="n">pars</span><span class="p">)</span><span class="o">.</span><span class="n">params</span>
        <span class="k">return</span> <span class="n">r_apo</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_centre</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        paper eq. 4 -- subject to change</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">)</span>  <span class="c1"># angular momentum</span>
        <span class="n">T</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">v0</span><span class="p">)</span>  <span class="c1"># kinetic energy</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># print(r0)s</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">T</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_potential</span><span class="p">(</span><span class="o">*</span><span class="n">pars</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r0</span><span class="p">)</span>  <span class="c1"># total energy</span>

        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">energy</span> <span class="o">-</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_potential</span><span class="p">(</span><span class="o">*</span><span class="n">pars</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">))</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_action_r</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">params</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
        <span class="n">v</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Integrand for radial action (B-T 2nd Ed. - eq. 3.224)</span>

<span class="sd">        .. math::</span>
<span class="sd">            J_{r}(\boldsymbol{x}, \boldsymbol{v} \mid \Phi)=\frac{1}{2 \pi} \oint v_{r} \mathrm{~d} r=\frac{1}{\pi} \int_{r_{-}}^{r_{+}}\left[2(E-\Phi)-\frac{L^{2}}{r^{2}}\right]^{1 / 2} \mathrm{~d} r</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : jax.Array</span>
<span class="sd">            position vector | [kpc]</span>
<span class="sd">        v : jax.Array</span>
<span class="sd">            velocity vector | [km s^{-1}]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            radial action | [kpc km s^{-1}]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_peri</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_apo</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="c1"># Gauss-Legendre integration</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="n">JaxPotential</span><span class="o">.</span><span class="n">_xm</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x0</span><span class="p">)</span>
        <span class="n">wi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="n">JaxPotential</span><span class="o">.</span><span class="n">_wm</span>

        <span class="n">L</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># abs(Angular momentum)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">energy</span> <span class="o">=</span> <span class="n">T</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_potential</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r0</span><span class="p">)</span>  <span class="c1"># total energy</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_potential</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">xi</span><span class="p">)</span>

        <span class="n">term1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">energy</span> <span class="o">-</span> <span class="n">term2</span><span class="p">)</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="n">L</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">xi</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># takes out the kpc units leaves it as km**2/s**2</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">term1</span> <span class="o">-</span> <span class="n">term3</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">wi</span> <span class="o">*</span> <span class="n">out</span><span class="p">)</span>

<div class="viewcode-block" id="JaxDensity.action_theta">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.action_theta">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
    <span class="k">def</span> <span class="nf">action_theta</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Polar action</span>
<span class="sd">        :math:`x` and :math:`v` are the position and velocity vectors in cartesian coordinates</span>

<span class="sd">        .. math::</span>
<span class="sd">            J_\theta(\boldsymbol{x}, \boldsymbol{v} \mid \Phi)=L-\left|L_\phi\right|,</span>

<span class="sd">        where :math:`L_\phi` is the azimuthal component of the angular momentum and :math:`L = |\boldsymbol{x}\times\boldsymbol{v}|` is the magnitude of the angular momentum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">L_vector</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">L_phi</span> <span class="o">=</span> <span class="n">L_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">L_vector</span><span class="p">,</span> <span class="n">L_vector</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">L</span> <span class="o">-</span> <span class="n">L_phi</span></div>


<div class="viewcode-block" id="JaxDensity.action_phi">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDensity.action_phi">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
    <span class="k">def</span> <span class="nf">action_phi</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Azimuthal action</span>

<span class="sd">        .. math::</span>
<span class="sd">            J_{\phi}(\boldsymbol{x}, \boldsymbol{v} \mid \Phi)=\frac{1}{2 \pi} \oint p_{\phi} \mathrm{d} \phi=L_{\phi}</span>
<span class="sd">        :math:`L_{\phi}= xv_{y} - yv_{x}` is the z-component of the angular momentum</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">L_phi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">L_phi</span></div>


    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_dJdOmega</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rt</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. math:</span>
<span class="sd">            \frac{dJ}{d\omega} = \int{\rho^{2}(r) d\ell}</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        theta : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First integrate from r_min to l_</span>

        <span class="c1"># l_min = d*jnp.cos(theta) - jnp.sqrt(rmin**2 - (d*jnp.sin(theta))**2)</span>

        <span class="n">l0</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rt</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">l_mid</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">l_mid</span> <span class="o">-</span> <span class="n">l0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_xj</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">l_mid</span> <span class="o">+</span> <span class="n">l0</span><span class="p">)</span>
        <span class="n">wi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">l_mid</span> <span class="o">-</span> <span class="n">l0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_wj</span>
        <span class="n">sum1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">wi</span>
            <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_density_fit</span><span class="p">(</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">d</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">xi</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)),</span> <span class="n">param_dict</span>
            <span class="p">)</span>
            <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span>

        <span class="c1"># Now integrate from rm to l+</span>
        <span class="n">l_max</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rt</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">xv</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">l_max</span> <span class="o">-</span> <span class="n">l_mid</span><span class="p">)</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_xj</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">l_max</span> <span class="o">+</span> <span class="n">l_mid</span><span class="p">)</span>
        <span class="n">wv</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">l_max</span> <span class="o">-</span> <span class="n">l_mid</span><span class="p">)</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_wj</span>
        <span class="n">sum2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">wv</span>
            <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_density_fit</span><span class="p">(</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xv</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">d</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">xv</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)),</span> <span class="n">param_dict</span>
            <span class="p">)</span>
            <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">sum1</span> <span class="o">+</span> <span class="n">sum2</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_jFactor</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rt</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        J-factor</span>
<span class="sd">        .. math:</span>
<span class="sd">            J= \int\int_{\rm los} \rho^{2}(r) d\Omega dl</span>

<span class="sd">        where we write r as :math:`r^2=\ell^2+d^2-2 \ell d \cos \theta` where :math:`\ell` is the distance along the line of sight and d is the distance to the center of the galaxy.</span>
<span class="sd">        Spherical symmetry lets us write :math:`d\Omega=2\pi\sin\theta d\theta`.</span>

<span class="sd">        The bounds on the line of sight are $\ell_{ \pm}=d \cos \theta \pm \sqrt{r_{200}^2-d^2 \sin ^2 \theta}$.</span>
<span class="sd">        where $r_{200}$ is the &#39;size&#39; of the system.</span>

<span class="sd">        substituting in the integral we get</span>
<span class="sd">        $$</span>
<span class="sd">        J(\theta_{\rm max}) = 2 \pi \int_{0}^{\theta_{\rm max}} \int_{\ell_{-}}^{\ell_{+}} \left[\rho\left(\sqrt{\ell^2+d^2-2 \ell d \cos \theta}\right)\right]^{2}\sin(\theta) d\ell d\theta</span>
<span class="sd">        $$</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        theta : float</span>
<span class="sd">            _description_</span>
<span class="sd">        d : float</span>
<span class="sd">            distance to system | [kpc]</span>
<span class="sd">        rt : float</span>
<span class="sd">            tidal radius of system | [kpc]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            J-factor | [:math:`M_{\odot}^{2}~kpc^{-5}]`</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Should rt just be r_200? should i just change the bounds on the line of sight part to be -inf to inf?</span>
<span class="sd">        Note the Units.</span>
<span class="sd">        Maybe I should just return log10(J/[GeV^{2} cm^{-5}]) instead of J?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># theta = jnp.atleast_1d(theta)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_xj</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x0</span><span class="p">)</span>
        <span class="n">wi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_wj</span>
        <span class="n">vectorized_func</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_dJdOmega</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
            <span class="mi">2</span>
            <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span>
            <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">wi</span> <span class="o">*</span> <span class="n">vectorized_func</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rt</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xi</span><span class="p">))</span>
            <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_GeV2cm5</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_dDdOmega</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        _summary_</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        theta : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        d : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        rt : _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l0</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rt</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">l1</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rt</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">l1</span> <span class="o">-</span> <span class="n">l0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xj</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">l1</span> <span class="o">+</span> <span class="n">l0</span><span class="p">)</span>
        <span class="n">wi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">l1</span> <span class="o">-</span> <span class="n">l0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wj</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">wi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">d</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">xi</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)))</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_dFactor</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decay Factor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        theta : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        d : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        rt : _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Decay Factor | [:math:`M_{\odot}~kpc^{-2}]`</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        TODO: Decide on the units and log10 or not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_xj</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x0</span><span class="p">)</span>
        <span class="n">wi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_wj</span>
        <span class="n">vectorized_func</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">dDdOmega</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
            <span class="mi">2</span>
            <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span>
            <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">wi</span> <span class="o">*</span> <span class="n">vectorized_func</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rt</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xi</span><span class="p">),</span> <span class="n">param_dict</span><span class="p">)</span>
            <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_GeVcm2</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">JaxDensity</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">return</span> <span class="n">CompositePotential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>



<div class="viewcode-block" id="JaxPotential">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxPotential">[docs]</a>
<span class="k">class</span> <span class="nc">JaxPotential</span><span class="p">(</span><span class="n">JaxDensity</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_potential</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_mass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define from potential function</span>

<span class="sd">        .. math::</span>
<span class="sd">            M(r) = r^{2} \frac{d\phi}{dr}</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dphi_dr</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_potential</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dphi_dr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_density</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ..math::</span>
<span class="sd">            \rho(r) = -\frac{1}{4\pi G} \nabla^{2} \phi(r)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        params : _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d2phi_dr2</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_potential</span><span class="p">))</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_G</span><span class="p">)</span> <span class="o">*</span> <span class="n">d2phi_dr2</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></div>



<div class="viewcode-block" id="JaxMass">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxMass">[docs]</a>
<span class="k">class</span> <span class="nc">JaxMass</span><span class="p">(</span><span class="n">JaxDensity</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_mass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_density</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        _summary_</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        params : _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dM_dr</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_mass</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dM_dr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>



<div class="viewcode-block" id="JaxDistribuitionFunction">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDistribuitionFunction">[docs]</a>
<span class="k">class</span> <span class="nc">JaxDistribuitionFunction</span><span class="p">(</span><span class="n">JaxDensity</span><span class="p">):</span>
<div class="viewcode-block" id="JaxDistribuitionFunction.df">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.JaxDistribuitionFunction.df">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">df</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        _summary_</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        E : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        params : _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


    <span class="nd">@classmethod</span>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_potential</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        params : _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">pass</span></div>



<div class="viewcode-block" id="CompositePotential">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.CompositePotential">[docs]</a>
<span class="k">class</span> <span class="nc">CompositePotential</span><span class="p">(</span><span class="n">JaxPotential</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Composite potential class that combines multiple potentials into a single potential.</span>

<span class="sd">    There are two ways to combine potentials:</span>

<span class="sd">    1. Add potentials using the &#39;+&#39; operator.</span>
<span class="sd">    2. Use the CompositePotential class to combine multiple potentials.</span>

<span class="sd">    Functions Here just sum the density, mass, and potential of each potential in the composite potential.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">potentials</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">potentials</span> <span class="o">=</span> <span class="n">potentials</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Merge _dm_priors from individual potentials with unique prefixes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dm_priors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">potentials</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">_dm_priors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">unique_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dm_priors</span><span class="p">[</span><span class="n">unique_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="CompositePotential.density">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.CompositePotential.density">[docs]</a>
    <span class="k">def</span> <span class="nf">density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sum the density of each potential in the composite potential.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : jnp.ndarray</span>
<span class="sd">            radii at which to calculate the density units of [kpc]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        jnp.ndarray</span>
<span class="sd">            density units of :math:`[ \\rm M_{\odot}~kpc^{-3}]`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">density</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">potentials</span><span class="p">]))</span></div>


<div class="viewcode-block" id="CompositePotential.mass">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.CompositePotential.mass">[docs]</a>
    <span class="k">def</span> <span class="nf">mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sum of the mass of each potential in the composite potential.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : jnp.ndarray</span>
<span class="sd">            radii, units of [kpc]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        jnp.ndarray</span>
<span class="sd">            mass units of :math:`[ \\rm M_{\odot}]`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">mass</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">potentials</span><span class="p">]))</span></div>


<div class="viewcode-block" id="CompositePotential.potential">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.CompositePotential.potential">[docs]</a>
    <span class="k">def</span> <span class="nf">potential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sum of the potential of each potential in the composite potential.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : jnp.ndarray</span>
<span class="sd">            radii, units of [kpc]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        jnp.ndarray</span>
<span class="sd">            potential units of :math:`[ \\rm km^{2}~s^{-2}]`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">potential</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">potentials</span><span class="p">]))</span></div>


    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;CompositePotential combining the following potentials:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">potentials</span><span class="p">):</span>
            <span class="n">description</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> with parameters:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">_dm_priors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">prior_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_prior</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">description</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;      </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">prior_str</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="c1"># Assuming each potential class has a method or attribute to get its parameters</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;_params&quot;</span><span class="p">):</span>
                <span class="n">description</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;      parameters: </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">_params</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">+=</span> <span class="s2">&quot;      parameters: Not available</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">description</span>

    <span class="k">def</span> <span class="nf">_format_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prior</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prior</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Uniform(low=</span><span class="si">{</span><span class="n">prior</span><span class="o">.</span><span class="n">low</span><span class="si">}</span><span class="s2">, high=</span><span class="si">{</span><span class="n">prior</span><span class="o">.</span><span class="n">high</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="c1"># Add other distributions as needed</span>
        <span class="c1"># elif isinstance(prior, dist.Normal):</span>
        <span class="c1">#     return f&quot;Normal(mean={prior.mean}, std={prior.std})&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">prior</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;CompositePotential with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">potentials</span><span class="p">)</span><span class="si">}</span><span class="s2"> potentials: &quot;</span>
            <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">potentials</span><span class="p">])</span>
            <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="Data">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data">[docs]</a>
<span class="k">class</span> <span class="nc">Data</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_r&quot;</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot;The &#39;_r&#39; component is not defined.\nOnly projected moments may be available.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pmr&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pmt&quot;</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot;&#39;pmr&#39; and &#39;pmt&#39; components are not defined.\nVelocity dispersion for these components will not be available.\n only &#39;los&#39; moment will be available&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_dispersion</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Initialize cache dictionary if it doesn&#39;t exist # could put this in an __init__function</span>

        <span class="c1"># required_components = (&#39;_r&#39;, &#39;_vr&#39;, &#39;_vtheta&#39;, &#39;_vphi&#39;, &#39;_R&#39;, &#39;_vlos&#39;, &#39;_pmr&#39;, &#39;_pmt&#39;)</span>
        <span class="c1"># if any(getattr(self, comp) is None for comp in required_components):</span>
        <span class="c1">#     warnings.warn(&quot;Some required instance variables are not defined.\nThis will limit the functionality of this function.&quot;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">N_star</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_R</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_component_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_component_map</span><span class="p">()</span>

<div class="viewcode-block" id="Data.construct_component_map">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.construct_component_map">[docs]</a>
    <span class="k">def</span> <span class="nf">construct_component_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">component_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_r&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_vr&quot;</span><span class="p">):</span>
            <span class="n">component_map</span><span class="p">[</span><span class="s2">&quot;radial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;d_vr&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_r&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_vtheta&quot;</span><span class="p">):</span>
            <span class="n">component_map</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_vtheta</span><span class="p">,</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;d_vtheta&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_r&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_vphi&quot;</span><span class="p">):</span>
            <span class="n">component_map</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vphi</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;d_vphi&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_R&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_vlos&quot;</span><span class="p">):</span>
            <span class="n">component_map</span><span class="p">[</span><span class="s2">&quot;los&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vlos</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;d_vlos&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_R&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pmr&quot;</span><span class="p">):</span>
            <span class="n">component_map</span><span class="p">[</span><span class="s2">&quot;pmr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;d_pmt&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_R&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pmt&quot;</span><span class="p">):</span>
            <span class="n">component_map</span><span class="p">[</span><span class="s2">&quot;pmt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmt</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;d_pmr&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">component_map</span></div>


<div class="viewcode-block" id="Data.dispersion_i">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.dispersion_i">[docs]</a>
    <span class="k">def</span> <span class="nf">dispersion_i</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">component</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;los&quot;</span><span class="p">,</span>
        <span class="n">binfunc</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">histogram</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="s2">&quot;blocks&quot;</span><span class="p">,</span>
        <span class="n">clear_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the dispersion of a given component e.g</span>

<span class="sd">        r_center,dispersion_i, dispersion_i_err = dispersion_i(&#39;los&#39;)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        component : str, optional</span>
<span class="sd">            The component for which to calculate the dispersion.</span>
<span class="sd">            Available components: &#39;radial&#39;, &#39;theta&#39;, &#39;phi&#39;, &#39;los&#39;, &#39;pmr&#39;, &#39;pmt&#39;.</span>
<span class="sd">            Defaults to &#39;los&#39;.</span>
<span class="sd">        binfunc : Callable, optional</span>
<span class="sd">            function used to bin data, by default histogram.</span>
<span class="sd">            As in astropy.stats.histogram</span>
<span class="sd">        bins : int or sequence of scalars or str, optional</span>
<span class="sd">            bin edges, by default &#39;blocks&#39;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : tuple</span>
<span class="sd">        A tuple containing three values:</span>
<span class="sd">            - r_center : array</span>
<span class="sd">              The center values for the dispersion bins.</span>
<span class="sd">            - dispersion_i : array</span>
<span class="sd">              The calculated dispersion for the specified component.</span>
<span class="sd">            - dispersion_error : array</span>
<span class="sd">              The uncertainty associated with the dispersion calculation.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Warning</span>
<span class="sd">            If the component type is unknown or missing.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - This function utilizes caching to store and reuse previously calculated dispersion results.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; # Use mock data set</span>
<span class="sd">        &gt;&gt;&gt; dataSet = pd.read_csv(&#39;data/gs010_bs050_rcrs025_rarcinf_cusp_0064mpc3_df_1000_3_err.dat&#39;)</span>
<span class="sd">        &gt;&gt;&gt; error = np.full_like(dataSet[&#39;x&#39;],2.0)</span>
<span class="sd">        &gt;&gt;&gt; # append error to dataSet</span>
<span class="sd">        &gt;&gt;&gt; dataSet[&#39;error&#39;] = error</span>
<span class="sd">        &gt;&gt;&gt; obj = data.Mockdata(dataset)</span>
<span class="sd">        &gt;&gt;&gt; r_center, dispersion_i, dispersion_error = obj.dispersion_i(&#39;radial&#39;)</span>
<span class="sd">        &gt;&gt;&gt; r_center, dispersion_default, dispersion_error = obj.dispersion_i()  # Calculate dispersion for the default component (&#39;los&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">component</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">component</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1"># Just in case there&#39;s random capitalizations by the user</span>

        <span class="k">if</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_dispersion</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">clear_cache</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;here actually&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_dispersion</span><span class="p">[</span><span class="n">component</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_map</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_map</span><span class="p">[</span><span class="n">component</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span><span class="p">(</span>
                <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">binfunc</span><span class="o">=</span><span class="n">binfunc</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_dispersion</span><span class="p">[</span><span class="n">component</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;here&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Unknown or missing component type.</span><span class="se">\n</span><span class="s2"> make sure you have the right data in order to calculate this component of the dispersion&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Optionally return a value if needed</span></div>


<div class="viewcode-block" id="Data.global_dispersion">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.global_dispersion">[docs]</a>
    <span class="k">def</span> <span class="nf">global_dispersion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">vi</span><span class="p">,</span> <span class="n">d_vi</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">global_velocity_model</span><span class="p">(</span><span class="n">vi</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
            <span class="c1"># Priors for mean velocity and global dispersion</span>
            <span class="n">mean_velocity</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;mean_velocity&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
            <span class="n">global_sigmav</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;global_sigmav&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>

            <span class="c1"># Likelihood for each observed velocity</span>
            <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vi</span><span class="p">)):</span>
                <span class="n">total_variance</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">global_sigmav</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">error</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mean_velocity</span><span class="p">,</span> <span class="n">total_variance</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">vi</span>
                <span class="p">)</span>

        <span class="c1"># MCMC</span>
        <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">NUTS</span><span class="p">(</span><span class="n">global_velocity_model</span><span class="p">)</span>
        <span class="n">mcmc</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mcmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">vi</span><span class="p">,</span> <span class="n">d_vi</span><span class="p">)</span>
        <span class="n">mcmc</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_velocity</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;mean_velocity&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_sigmav</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;global_sigmav&quot;</span><span class="p">]</span>

        <span class="n">meanv</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean_velocity</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_sigmav</span><span class="p">)</span>

        <span class="c1"># Plotting</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="c1"># Histogram of velocities</span>
            <span class="n">N</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">histogram</span><span class="p">(</span><span class="n">vi</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s2">&quot;blocks&quot;</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

            <span class="c1"># import matplotlib.pyplot as plt</span>
            <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
            <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">gaussian_kde</span>

            <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">vi</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;skyblue&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;density&quot;</span><span class="p">)</span>

            <span class="c1"># Density Plot with KDE</span>
            <span class="n">kde</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">vi</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">d_vi</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">vi</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">vi</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="n">kde_values</span> <span class="o">=</span> <span class="n">kde</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="c1"># Confidence interval (e.g., 95%)</span>
            <span class="n">ci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">kde_values</span><span class="p">,</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">kde_values</span><span class="p">,</span>
                <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">kde_values</span> <span class="o">&gt;=</span> <span class="n">ci</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">kde_values</span> <span class="o">&lt;=</span> <span class="n">ci</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">vi</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>

            <span class="c1"># Best-fit Gaussian curve</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">meanv</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Fit results: mean = </span><span class="si">{:.2f}</span><span class="s2">,  std = </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meanv</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Velocity&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean_velocity</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_sigmav</span><span class="p">)</span></div>


<div class="viewcode-block" id="Data.dispersion">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.dispersion">[docs]</a>
    <span class="k">def</span> <span class="nf">dispersion</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ri</span><span class="p">,</span>
        <span class="n">vi</span><span class="p">,</span>
        <span class="n">d_vi</span><span class="p">,</span>
        <span class="n">component</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">binfunc</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">histogram</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="s2">&quot;blocks&quot;</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calculates the dispersion of velocity component, v_i at radii r</span>
<span class="sd">        -- or at project radius R. Also calcualtes the</span>
<span class="sd">        error (see dispersion_error() for details)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        v_i : _type_</span>
<span class="sd">            component of velocity you want to calculate the dispersion of</span>
<span class="sd">            e.g vx,vy,vz,vr,vtheta,vphi etc...</span>
<span class="sd">        binfunc : Callable, optional</span>
<span class="sd">        binning function -- must return two values like np.histogram, by default histogram</span>
<span class="sd">        bins : str, optional</span>
<span class="sd">            binning scheme I guess , by default &#39;blocks&#39;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># first bin positions -- Note: this will only take anytime the first time this function is run -- results are then cached</span>
        <span class="n">N</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">binfunc</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>

        <span class="n">r_center</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="p">)</span>  <span class="c1"># Using the center of the bins seems like an ok method -- a mean or median might be better though</span>

        <span class="c1"># Next get global dispersion and mean velocity</span>
        <span class="n">meanv</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_dispersion</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">vi</span><span class="p">,</span> <span class="n">d_vi</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">)</span>

        <span class="n">N</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">binnumber</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">vi</span><span class="p">,</span> <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">)</span>

        <span class="n">num_bins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">def</span> <span class="nf">velocity_dispersion_model</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">vi</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">global_dispersion</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">):</span>
            <span class="c1"># Number of bins</span>
            <span class="n">num_bins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="c1"># Dispersion hyperprior based on global dispersion</span>
            <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;dispersion_hyperprior&quot;</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">):</span>
                <span class="n">dispersion</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="s2">&quot;dispersion&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="n">global_dispersion</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Use binnumber to assign data to bins</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">bin_mask</span> <span class="o">=</span> <span class="n">binnumber</span> <span class="o">==</span> <span class="n">i</span>
                <span class="n">bin_vi</span> <span class="o">=</span> <span class="n">vi</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">]</span>
                <span class="n">bin_error</span> <span class="o">=</span> <span class="n">error</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">]</span>

                <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bin_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_vi</span><span class="p">)):</span>
                    <span class="n">obs_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;obs_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                        <span class="n">obs_name</span><span class="p">,</span>
                        <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
                            <span class="n">meanv</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dispersion</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">bin_error</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                        <span class="p">),</span>
                        <span class="n">obs</span><span class="o">=</span><span class="n">bin_vi</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="c1"># MCMC</span>
        <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">NUTS</span><span class="p">(</span><span class="n">velocity_dispersion_model</span><span class="p">)</span>
        <span class="n">mcmc</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mcmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">vi</span><span class="p">,</span> <span class="n">d_vi</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>
        <span class="n">mcmc</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;dispersion&quot;</span><span class="p">]</span>
        <span class="c1"># Assuming &#39;mcmc&#39; is your MCMC object after running the sampling</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
        <span class="n">dispersion_samples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;dispersion&quot;</span><span class="p">]</span>
        <span class="c1"># mean_velocity_samples = samples[&#39;mean_velocity&#39;]</span>
        <span class="n">dispersion_means</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dispersion_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Calculate the standard deviation</span>
        <span class="n">dispersion_std</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dispersion_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Plotting</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="c1"># Create a new figure and set of subplots</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

            <span class="c1"># Histogram of velocities for each bin</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">bin_mask</span> <span class="o">=</span> <span class="n">binnumber</span> <span class="o">==</span> <span class="n">i</span>
                <span class="n">bin_vi</span> <span class="o">=</span> <span class="n">vi</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">]</span>

                <span class="c1"># Plot histogram for each bin</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bin_vi</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Bin </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Best-fit Gaussian curve for each bin</span>
                <span class="n">bin_meanv</span> <span class="o">=</span> <span class="n">meanv</span>  <span class="c1"># If mean is constant across bins</span>
                <span class="n">bin_dispersion</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bin_vi</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">bin_vi</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bin_meanv</span><span class="p">,</span> <span class="n">bin_dispersion</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Velocity Histogram and Gaussian Fits for Each Bin&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Velocity&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r_center</span><span class="p">),</span>
            <span class="n">dispersion_means</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dispersion_std</span><span class="p">),</span>
            <span class="n">bin_edges</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Data.dispersion_errors">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.dispersion_errors">[docs]</a>
    <span class="k">def</span> <span class="nf">dispersion_errors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">vi</span><span class="p">,</span> <span class="n">d_vi</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">Nmonte</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Nbins</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Very Basic Error calculation for dispersion</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Nmonte : int</span>
<span class="sd">            Number of times to sample errors  &lt;= Number of observations</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Maybe I should do this using EMCEE instead or Numpyro I guess</span>
<span class="sd">        TODO: add observational error as input? atm its just set to 2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if (error.any() == None): error= 2 # gotta change that 2 but need real errors first</span>
        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_star</span>
        <span class="n">stemp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nmonte</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Nbins</span><span class="p">)))</span>
        <span class="n">meanv</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vi</span><span class="p">)</span>  <span class="c1"># Probably shouldn&#39;t assume that v_{com} = 0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nmonte</span><span class="p">):</span>
            <span class="c1"># Draw new velocities by sampling a gaussian distribution</span>
            <span class="c1"># centered at the measured velocity with a sigma = observational error</span>
            <span class="n">vlos_new</span> <span class="o">=</span> <span class="n">vi</span> <span class="o">+</span> <span class="n">error</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
            <span class="c1"># next calculate the dispersion of the new velocities</span>
            <span class="n">mu</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span>
                <span class="n">ri</span><span class="p">,</span> <span class="p">(</span><span class="n">meanv</span> <span class="o">-</span> <span class="n">vlos_new</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span>
            <span class="p">)</span>
            <span class="n">stemp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu</span>

        <span class="n">meanv</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vi</span><span class="p">)</span>  <span class="c1"># Probably shouldn&#39;t assume that v_{com} = 0</span>
        <span class="n">mu</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">bin_numbers</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span>
            <span class="n">ri</span><span class="p">,</span> <span class="p">(</span><span class="n">meanv</span> <span class="o">-</span> <span class="n">vi</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span>
        <span class="p">)</span>
        <span class="n">N</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">bin_numbers</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">)</span>

        <span class="c1"># Get standard deviation of the Nmonte iterations</span>
        <span class="n">mError</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">stemp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Add Poisson error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mError</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">mu</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_error</span></div>


<div class="viewcode-block" id="Data.plot_dispersion_i">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.plot_dispersion_i">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_dispersion_i</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">component</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">binfunc</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">histogram</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="s2">&quot;blocks&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_dispersion</span><span class="p">:</span>
            <span class="n">r_center</span><span class="p">,</span> <span class="n">dispersion</span><span class="p">,</span> <span class="n">dispersion_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_dispersion</span><span class="p">[</span><span class="n">component</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">r_center</span><span class="p">,</span> <span class="n">dispersion</span><span class="p">,</span> <span class="n">dispersion_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersion_i</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

        <span class="c1"># fig,ax = plt.subplots()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">r_center</span><span class="p">,</span> <span class="n">dispersion</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">&quot;mid&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
            <span class="n">r_center</span><span class="p">,</span>
            <span class="n">dispersion</span><span class="p">,</span>
            <span class="n">yerr</span><span class="o">=</span><span class="n">dispersion_error</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="n">ecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
            <span class="n">elinewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">xscale</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;R [kpc]&quot;</span><span class="p">,</span>
            <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\sigma_</span><span class="si">{los}</span><span class="s2">$ [km/s]&quot;</span><span class="p">,</span>
            <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Data.plot_spatial">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.plot_spatial">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_spatial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">component</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></div>


<div class="viewcode-block" id="Data.fourth_moment">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.fourth_moment">[docs]</a>
    <span class="k">def</span> <span class="nf">fourth_moment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">vi</span><span class="p">,</span> <span class="n">d_vi</span><span class="p">,</span> <span class="n">binfunc</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">histogram</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s2">&quot;blocks&quot;</span><span class="p">):</span>
        <span class="n">N</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">binfunc</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
        <span class="n">r_center</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">meanv</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vi</span><span class="p">)</span>  <span class="c1"># Probably shouldn&#39;t assume that v_{com} = 0</span>
        <span class="n">mu</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">bin_numbers</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span>
            <span class="n">ri</span><span class="p">,</span> <span class="p">(</span><span class="n">meanv</span> <span class="o">-</span> <span class="n">vi</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span>
        <span class="p">)</span>
        <span class="n">s4_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersion_errors</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="c1"># s_error = s4_error/2/np.sqrt(mu)</span>

        <span class="k">return</span> <span class="n">r_center</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">s4_error</span></div>


<div class="viewcode-block" id="Data.spatial_density">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.spatial_density">[docs]</a>
    <span class="k">def</span> <span class="nf">spatial_density</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">bin_method</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">histogram</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s2">&quot;blocks&quot;</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a set of N stars with either 2D (default) or 3D(set dim=3),</span>
<span class="sd">        compute a spatial density</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bin_method : Callable, optional</span>
<span class="sd">            binning function (e.g. np.histogram)</span>
<span class="sd">            must return just two things so dont use plt.hist</span>
<span class="sd">            by default histogram (astropy&#39;s histogram)</span>
<span class="sd">        bins : str or ndarray, optional, default is &#39;blocks&#39;</span>
<span class="sd">            bin edges -- &#39;blocks&#39; only works with astropy&#39;s histogram method</span>
<span class="sd">        dim : int, optional</span>
<span class="sd">            Either Calculate, by default 2</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">N</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">bin_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">N</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">bin_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>

            <span class="n">v_shell</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">r_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="n">v_shell</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">N</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">bin_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_R</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span><span class="p">)</span>
                <span class="n">v_shell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">r_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">nu</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="n">v_shell</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">N</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">bin_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_R</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
                <span class="n">v_shell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">r_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">nu</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="n">v_shell</span>

        <span class="k">return</span> <span class="n">r_center</span><span class="p">,</span> <span class="n">nu</span></div>


<div class="viewcode-block" id="Data.spatial_nonpar">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.spatial_nonpar">[docs]</a>
    <span class="k">def</span> <span class="nf">spatial_nonpar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        _summary_</span>
<span class="sd">        TODO: write this lol -- see APWs jax implementation maybe?</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dims : int, optional</span>
<span class="sd">            _description_, by default 2</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span></div>


<div class="viewcode-block" id="Data.spatial_errors">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.spatial_errors">[docs]</a>
    <span class="k">def</span> <span class="nf">spatial_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nmonte</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="n">stemp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nmonte</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nmonte</span><span class="p">):</span>
            <span class="n">vlos_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">errors</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
            <span class="n">mu</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">vlos_new</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span>
            <span class="p">)</span>
            <span class="n">stemp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu</span>
        <span class="n">mError</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">stemp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mError</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">mu</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">error</span></div>


<div class="viewcode-block" id="Data.bspline_projected">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.bspline_projected">[docs]</a>
    <span class="k">def</span> <span class="nf">bspline_projected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the projected density profile of a set of stars</span>
<span class="sd">        given their projected radii R</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        R : np.ndarray</span>
<span class="sd">            Projected Radii of stars</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            projected density profile at radius R</span>
<span class="sd">        NOTES</span>
<span class="sd">        -----</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">Data</span><span class="o">.</span><span class="n">bspline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_R</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">spl</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">chi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span></div>

        <span class="c1"># return  0.5*np.exp(spl(chi))/(R**2*np.pi)</span>

<div class="viewcode-block" id="Data.bspline_3d">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.bspline_3d">[docs]</a>
    <span class="k">def</span> <span class="nf">bspline_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the density profile of a set of stars</span>
<span class="sd">        given their radius r</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : np.ndarray</span>
<span class="sd">            _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            density profile at radius r</span>
<span class="sd">        TODO: clean up notation on this and projected version</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">Data</span><span class="o">.</span><span class="n">bspline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">spl</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">chi</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span></div>


<div class="viewcode-block" id="Data.spherical">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.spherical">[docs]</a>
    <span class="k">def</span> <span class="nf">spherical</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert cartesian coordinates :math:`(x,y,z,vx,vy,vz)` to spherical coordinates :math:`(r,\theta,\phi,v_{r},v_{\theta},v_{\phi})`</span>

<span class="sd">        This is done by the following transformations:</span>
<span class="sd">        - :math:`r = \sqrt{x^2+y^2+z^2}`</span>
<span class="sd">        - :math:`\theta = arccos(z/r)`</span>
<span class="sd">        - :math: `\phi  = arctan2(y,x)  = sign(y)arcos(R/z)`</span>
<span class="sd">        - :math:`v_{r} = \frac{xv_{x}+yv_{y}+zv_{z}}{r}`</span>
<span class="sd">        - :math:`v_{\phi}= \frac{yv_{x}-xv_{y}}{R}`</span>
<span class="sd">        - :math:`v_{\theta] =\frac{\frac{zxv_{x}}[R] + \frac{zyv_{y}}{R} - Rv_{z}}{r}`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># (x,y,z) -&gt; r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># for conveniences</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># (vx,vy,vz) -&gt; (vr,v_{\theta},v_{\phi})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vr</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vy</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vz</span>
        <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vphi</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vx</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vy</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_R</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vtheta</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vx</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_R</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vy</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_R</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_R</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vz</span>
        <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span></div>

        <span class="c1"># return self._r, self._vr, self._vtheta,self._vphi</span>

<div class="viewcode-block" id="Data.cylindrical">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.cylindrical">[docs]</a>
    <span class="k">def</span> <span class="nf">cylindrical</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        convert cartesian velocities to cylindrical units</span>

<span class="sd">        .. math::</span>
<span class="sd">            (v_x,v_y,v_z) \rightarrow (v_{\rho},v_{\phi},v_{z})</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># proper motions</span>
        <span class="c1"># using theta</span>
        <span class="c1"># theta = jnp.arccos(self._z/self._r) # or jnp.arctan2(self._R,self._z)</span>
        <span class="c1"># self._pmr     = self._vr*jnp.sin(theta) + self._vtheta*jnp.cos(theta)</span>
        <span class="c1"># self._vz_test = self._vr*jnp.cos(theta) - self._vtheta*jnp.sin(theta)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pmr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_R</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vtheta</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vz_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_R</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vtheta</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vphi</span></div>

        <span class="c1"># return self._pmr,self._pmt,self._vz_test</span>

    <span class="c1"># @classmethod</span>
<div class="viewcode-block" id="Data.fit_projection">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.fit_projection">[docs]</a>
    <span class="k">def</span> <span class="nf">fit_projection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">[],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)):</span>
        <span class="n">R_center</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_density</span><span class="p">()</span>
        <span class="c1"># fit to projected density profile</span>
        <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">R_center</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">R_center</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">&quot;mid&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">R_center</span><span class="p">,</span> <span class="n">profile</span><span class="p">(</span><span class="n">R_center</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;fit&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;R [kpc]&quot;</span><span class="p">,</span>
            <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\rm\Sigma(R)~N~kpc^{-2}$&quot;</span><span class="p">,</span>
            <span class="n">xscale</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span>
            <span class="n">yscale</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span></div>


<div class="viewcode-block" id="Data.fit_gaussian">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.fit_gaussian">[docs]</a>
    <span class="k">def</span> <span class="nf">fit_gaussian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v_i</span><span class="p">,</span> <span class="n">error_i</span><span class="p">,</span> <span class="n">rhalf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key_</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
        <span class="c1"># Run NUTS.</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">NUTS</span><span class="p">(</span><span class="n">Data</span><span class="o">.</span><span class="n">gaussian</span><span class="p">)</span>
        <span class="n">num_samples</span> <span class="o">=</span> <span class="mi">3000</span>
        <span class="n">mcmc</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">)</span>
        <span class="n">mcmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rng_key_</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">v_i</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error_i</span><span class="p">,</span> <span class="n">rhalf</span><span class="o">=</span><span class="n">rhalf</span><span class="p">)</span>
        <span class="n">mcmc</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
        <span class="n">samples_1</span> <span class="o">=</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
        <span class="c1"># corner.corner(samples_1,var_names=[&#39;mu&#39;,&#39;sigma&#39;,&#39;mwolf&#39;],quantiles=[0.16, 0.5, 0.84],show_titles=True,labels=[r&#39;$\mu$&#39;,r&#39;$\sigma$&#39;,r&#39;$M_{\rm wolf}$&#39;],title_fmt=&#39;2.f&#39;);</span>
        <span class="k">return</span> <span class="n">samples_1</span></div>


<div class="viewcode-block" id="Data.mass_estimator">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.mass_estimator">[docs]</a>
    <span class="k">def</span> <span class="nf">mass_estimator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">estimator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Wolf&quot;</span><span class="p">,</span> <span class="n">rhalf</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Use the average velocity dispersion of your data to estimate the mass at the half-light radius</span>
<span class="sd">        using the estimator of your choice.</span>

<span class="sd">        For radial velocities, you have the option of Wolf, or Walker.</span>

<span class="sd">        If your data contains proper motions, you can use the estimator proposed in Errani et al. 2018.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        estimator : str, optional</span>
<span class="sd">            The estimator to use for the mass calculation</span>
<span class="sd">            Options: &#39;Wolf&#39;, &#39;Walker&#39;, &#39;Errani&#39;</span>
<span class="sd">            Defaults to &#39;Wolf&#39;</span>
<span class="sd">        rhalf : float, optional</span>
<span class="sd">            The half-light radius of the system</span>
<span class="sd">            Defaults to None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The estimated mass at the half-light radius</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If rhalf is non then check if it is in the data, if not raise an error</span>
        <span class="k">if</span> <span class="n">rhalf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhalf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;rhalf must be specified&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rhalf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhalf</span>

        <span class="c1"># fit the velocity data to a gaussian using match case to select the estimator</span>
        <span class="k">match</span> <span class="n">estimator</span><span class="p">:</span>
            <span class="k">case</span> <span class="s2">&quot;Wolf&quot;</span><span class="p">:</span>
                <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_gaussian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vlos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vlos_error</span><span class="p">,</span> <span class="n">rhalf</span><span class="o">=</span><span class="n">rhalf</span><span class="p">)</span>
                <span class="n">disp</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

            <span class="k">case</span> <span class="s2">&quot;Walker&quot;</span><span class="p">:</span>
                <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_gaussian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vlos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vlos_error</span><span class="p">,</span> <span class="n">rhalf</span><span class="o">=</span><span class="n">rhalf</span><span class="p">)</span>
                <span class="n">disp</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

            <span class="k">case</span> <span class="s2">&quot;Errani&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span></div>


<div class="viewcode-block" id="Data.bspline">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.bspline">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">bspline</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See e.g. Rehemtulla 2022</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        TODO: must make tuning paramaters be an input to this function</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># Definining this for convenience</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">stop</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">num</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># This make</span>
        <span class="n">chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="c1"># chi = np.linspace(np.log(x.min()), np.log(x.max()), 100)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">agama</span><span class="o">.</span><span class="n">splineLogDensity</span><span class="p">(</span><span class="n">chi</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">spl</span></div>


<div class="viewcode-block" id="Data.random_rotation">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.random_rotation">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">random_rotation</span><span class="p">(</span><span class="n">pos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="mi">360</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">rot</span> <span class="o">=</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">from_euler</span><span class="p">(</span><span class="s2">&quot;xyz&quot;</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">(),</span> <span class="n">pos</span><span class="p">)</span></div>


<div class="viewcode-block" id="Data.to_spherical">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.to_spherical">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">to_spherical</span><span class="p">(</span><span class="n">pos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">vel</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="c1"># (x,y,z) -&gt; r</span>
        <span class="n">Rp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># for conveniences</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># (vx,vy,vz) -&gt; (vr,v_{\theta},v_{\phi})</span>
        <span class="n">v_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vel</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vel</span><span class="p">[</span><span class="s2">&quot;vy&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vel</span><span class="p">[</span><span class="s2">&quot;vz&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">r</span>
        <span class="n">v_phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vel</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vel</span><span class="p">[</span><span class="s2">&quot;vy&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">Rp</span>
        <span class="n">v_theta</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pos</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vel</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">Rp</span>
            <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vel</span><span class="p">[</span><span class="s2">&quot;vy&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">Rp</span>
            <span class="o">-</span> <span class="n">Rp</span> <span class="o">*</span> <span class="n">vel</span><span class="p">[</span><span class="s2">&quot;vz&quot;</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">r</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">v_r</span><span class="p">,</span> <span class="n">v_phi</span><span class="p">,</span> <span class="n">v_theta</span></div>


<div class="viewcode-block" id="Data.gaussian">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.gaussian">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">gaussian</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">rhalf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        simple numpyro model function for finding the mean velocity of stars</span>

<span class="sd">        .. math::</span>
<span class="sd">            P(v|\mu,\sigma) = \frac{1}{\sqrt{2\pi}\sigma}e^{\frac{(v-\mu)^{2}}{2\sigma^{2}}}</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : _type_</span>
<span class="sd">            presumably velocities</span>
<span class="sd">        error : _type_</span>
<span class="sd">            error on velocities</span>
<span class="sd">        rhalf : _type_, optional</span>
<span class="sd">            If you want to calculate the Wolf mass, you can supply an r_{1/2}, by default None</span>

<span class="sd">        NOTES</span>
<span class="sd">        -----f</span>
<span class="sd">        Where do  the r_{1/2}&#39;s come from</span>
<span class="sd">        It&#39;d be nice if i could use r_{1/2}&#39;s with an error</span>
<span class="sd">        e.g.</span>
<span class="sd">        rh       = numpyro.sample(&#39;rhalf&#39;,dist.Normal(rhalf,drhalf))</span>
<span class="sd">        mwolf    = numpyro.deterministic(&#39;mwolf&#39;,(4*rh*sigma**2)/(3*G))</span>
<span class="sd">        should add a with numpyro plate</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">G</span> <span class="o">=</span> <span class="mf">4.30091731e-6</span>  <span class="c1"># Gravitational constant units [$kpc~km^{2}~M_{\odot}^{-1}~s^{-2}$]</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">rhalf</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mwolf</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mwolf&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">rhalf</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">G</span><span class="p">))</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">error</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">s</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="Data.dynamical_mass">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.Data.dynamical_mass">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">dynamical_mass</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">q_eval</span><span class="p">,</span> <span class="n">l_grav</span><span class="o">=</span><span class="mi">87</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">kpc</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the mass profile of a system using the spherical Jeans equation:</span>

<span class="sd">        .. math::</span>
<span class="sd">            M(&lt;r)=-\frac{r \overline{v_r^2}}{G}\left(\frac{\mathrm{d} \ln \rho}{\mathrm{d} \ln r} + \frac{\mathrm{d} \ln \overline{v_r^2}}{\mathrm{~d} \ln r}+2 \beta\right)</span>

<span class="sd">        All terms in the Equation above are calculated using B-splines</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        system : Data</span>
<span class="sd">            Should be either a KeckData, DCJLData or MockData object (subclasses of Data clas)</span>
<span class="sd">        q_eval : ndarray</span>
<span class="sd">            radii at which to evaluate the mass | units: [kpc]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Mass evaluated at q_eval | units: :math:`[\rm M_{\odot}]`</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        TODO: Currently only works for the specific DCJL simulated Dwarf&#39;s</span>
<span class="sd">        TODO: Need a better way to do this so that I dont have to calculate every term everytime i call this</span>
<span class="sd">        TODO: Get rid of Agama and instead use a Jax implementation of of these functions.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        `Rehemtulla et al. 2022 &lt;https://ui.adsabs.harvard.edu/abs/2022MNRAS.511.5536R/abstract&gt;`_</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get all stellar positions and velocities</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">r</span>  <span class="c1"># [kpc]</span>
        <span class="n">vr_sq</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">_vr</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># [km^{2}~s^{-2}]</span>
        <span class="n">vtheta_sq</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">_vtheta</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># [km^{2}~s^{-2}]</span>
        <span class="n">vphi_sq</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">_vphi</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># [km^{2}~s^{-2}]</span>

        <span class="c1"># calculate knots (i.e Where to evaluate B-splines)</span>
        <span class="c1"># NOTE: NEED to change this, but its ok for know since i&#39;m only using it on the simulated dwarfs</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span>
        <span class="n">lBound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="mi">4</span> <span class="o">*</span> <span class="n">l_grav</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kpc</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="p">)</span>  <span class="c1"># only trust the velocity values after 4 l_grav&#39;s</span>
        <span class="n">uBound</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="n">rknot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span>
            <span class="n">start</span><span class="o">=</span><span class="n">lBound</span><span class="p">,</span>  <span class="c1"># only trust the velocity values after 4 l_grav&#39;s</span>
            <span class="n">stop</span><span class="o">=</span><span class="n">uBound</span><span class="p">,</span>
            <span class="n">num</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>  <span class="c1"># TODO: this should be a parameter -- but i&#39;m still unsure of how many I should use</span>
            <span class="n">base</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>  <span class="c1"># There&#39;s definitely a better way of doing this</span>

        <span class="n">knots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rknot</span><span class="p">)</span>  <span class="c1"># mostly use log(rknots so)</span>

        <span class="n">vr_bspline</span> <span class="o">=</span> <span class="n">agama</span><span class="o">.</span><span class="n">splineApprox</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">vr_sq</span><span class="p">)</span>
        <span class="n">vtheta_bspline</span> <span class="o">=</span> <span class="n">agama</span><span class="o">.</span><span class="n">splineApprox</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">vtheta_sq</span><span class="p">)</span>
        <span class="n">vphi_bspline</span> <span class="o">=</span> <span class="n">agama</span><span class="o">.</span><span class="n">splineApprox</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">vphi_sq</span><span class="p">)</span>

        <span class="n">logq_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">q_eval</span><span class="p">)</span>
        <span class="n">vr_fit</span> <span class="o">=</span> <span class="n">vr_bspline</span><span class="p">(</span><span class="n">logq_eval</span><span class="p">)</span>
        <span class="n">vtheta_fit</span> <span class="o">=</span> <span class="n">vtheta_bspline</span><span class="p">(</span><span class="n">logq_eval</span><span class="p">)</span>
        <span class="n">vphi_fit</span> <span class="o">=</span> <span class="n">vphi_bspline</span><span class="p">(</span><span class="n">logq_eval</span><span class="p">)</span>

        <span class="n">beta</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">vtheta_fit</span> <span class="o">+</span> <span class="n">vphi_fit</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vr_fit</span><span class="p">))</span>
        <span class="n">G</span> <span class="o">=</span> <span class="mf">4.3e-6</span>  <span class="c1"># kpc km2 Msun-1 s-2</span>
        <span class="n">dvr</span> <span class="o">=</span> <span class="n">vr_bspline</span><span class="p">(</span><span class="n">logq_eval</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">agama</span><span class="o">.</span><span class="n">splineLogDensity</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">radii</span><span class="p">),</span> <span class="n">w</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">)))</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">rho_eval</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">q_eval</span><span class="p">)</span>  <span class="c1"># This has units of N_{\star}/kpc^3</span>
        <span class="n">dlnrho_dlnr</span> <span class="o">=</span> <span class="n">dlnrho_dlnr_eval</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">q_eval</span><span class="p">)</span>  <span class="c1"># unitless</span>

        <span class="c1"># Split Spherical Jeans Eq (e.g. Eq. 1 in Rehemtulla et al. 2022) into three terms</span>
        <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="n">dlnrho_dlnr</span>
        <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="n">dvr</span> <span class="o">/</span> <span class="n">vr_fit</span>
        <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">beta</span>
        <span class="n">M_jeans</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vr_fit</span><span class="p">)</span> <span class="o">*</span> <span class="n">q_eval</span> <span class="o">/</span> <span class="n">G</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">q_eval</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">M_jeans</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="rho_eval">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.rho_eval">[docs]</a>
<span class="k">def</span> <span class="nf">rho_eval</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates rho(r)</span>
<span class="sd">    S(log r) is log of tracer count (intended to be used with agama.splineLogDensity and weights=1)</span>
<span class="sd">    r is point or array of points where rho should be evaluated</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span></div>



<div class="viewcode-block" id="dlnrho_dlnr_eval">
<a class="viewcode-back" href="../../dynamicAll.base.html#dynamicAll.base.dlnrho_dlnr_eval">[docs]</a>
<span class="k">def</span> <span class="nf">dlnrho_dlnr_eval</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calcualtes dlnrho / dlnr</span>
<span class="sd">    S(log r) is log of tracer count (intended to be used with agama.splineLogDensity and weights=1)</span>
<span class="sd">    r is point or array of points where rho should be evaluated</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">S</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2024, Juan Guerra.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>